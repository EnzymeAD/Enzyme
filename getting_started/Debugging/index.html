<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Debugging - Enzyme AD</title><meta name=description content="Enzyme AD Compiler framework"><meta name=generator content="Hugo 0.74.3"><link href=index.xml rel=alternate type=application/rss+xml><link rel=canonical href=/getting_started/Debugging/><link rel=stylesheet href=css/theme.css><script src=https://use.fontawesome.com/releases/v5.0.6/js/all.js></script><link rel=stylesheet href=css/chroma.min.css><script src=https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js></script><script src=https://cdn.jsdelivr.net/npm/jquery.easing@1.4.1/jquery.easing.min.js></script><script src=js/bundle.js></script><style>:root{}</style></head><body><div class=container><header><h1><div><img src=/mlir-logo.png width=40px align=absmiddle>
Enzyme AD</div></h1><p class=description>Enzyme AD Compiler framework</p></header><div class=global-menu><nav><ul><li class=parent><a href>Community<i class="fas fa-angle-right"></i></a><ul class=sub-menu><li class=child><a href=https://groups.google.com/d/forum/enzyme-dev>Discussion List</a></li></ul></li><li><a href=/getting_started/Debugging/>Debugging</a></li><li><a href=/getting_started/Faq/>FAQ</a></li><li class=parent><a href=https://github.com/wsmoses/Enzyme>Source<i class="fas fa-angle-right"></i></a><ul class=sub-menu><li class=child><a href=/doxygen/>Doxygen</a></li><li class=child><a href=https://github.com/wsmoses/Enzyme>GitHub</a></li></ul></li><li><a href=https://github.com/wsmoses/Enzyme/issues>Bugs</a></li></ul></nav></div><div class=content-container><main><h1>Debugging</h1><h1 id=mlir-debugging-tips>MLIR Debugging Tips</h1><h2 id=inspecting-compilation>Inspecting compilation&nbsp;<a class=headline-hash href=#inspecting-compilation>¶</a></h2><p>There&rsquo;s no silver bullet for debugging the compilation process. Standard debugging techniques (printf debugging, gdb/lldb, IDE graphical debuggers, etc.) are of course applicable, but below are MLIR-specific facilities that are quite useful before diving into a generic debug flow. These facilities assume that you have reduced your problem to a form that can be reproduced with <code>mlir-opt</code> or another program that hooks into MLIR&rsquo;s option parsing, if this is not the case, see section &ldquo;Isolating test case&rdquo; below.</p><ul><li><p><code>-mlir-print-stacktrace-on-diagnostic</code> causes a stacktrace to be printed when a diagnostic is emitted. This can be useful to quickly get an idea where in a pass an error is happening.</p></li><li><p>When dealing with verifier errors, <code>--verify-each=0</code> turns off the verifier, allowing one to see the full invalid IR</p><ul><li><code>-mlir-print-op-generic</code> is often useful in combination, since many verifier errors also result in instructions that cannot be printed in their &ldquo;pretty form&rdquo;.</li></ul></li><li><p>When using the dialect conversion / pattern rewriting infrastructure <code>-debug-only=dialect-conversion</code> prints an exceedingly useful trace of the decisions that were made and why.</p></li><li><p><code>-debug-only=mydebugtag</code> coupled with use of the <code>LLVM_DEBUG</code> facility to just get debug info for things you are working on.</p></li><li><p><code>-mlir-elide-elementsattrs-if-larger</code> prints large constants in a redacted form, making the IR easier to scan.</p></li></ul><h2 id=isolating-test-cases>Isolating test cases&nbsp;<a class=headline-hash href=#isolating-test-cases>¶</a></h2><p>Isolating your problem to the inspection of manageable set of passes (ideally a single pass) is one of the most important parts of debugging a compiler, but sometimes this can be difficult in larger compilation flow.</p><h3 id=extracting-a-mlir-file-and-a-pass-pipeline>Extracting a <code>.mlir</code> file and a pass pipeline.&nbsp;<a class=headline-hash href=#extracting-a-mlir-file-and-a-pass-pipeline>¶</a></h3><p>MLIR&rsquo;s core infrastructure has the ability to
<a href=../docs/PassManagement.md#crash-and-failure-reproduction>create a &ldquo;crash reproducer&rdquo;</a>
and this functionality should be added to your compilation flows. Additionally, you should ensure that <code>.mlir</code> files are dumped during your compilation flow at key points such that even if compilation succeeds (possibly spuriously, such as with a miscompile), then there is still a starting point for dropping into <code>mlir-opt</code>.</p><h3 id=isolating-a-buggy-pass>Isolating a buggy pass&nbsp;<a class=headline-hash href=#isolating-a-buggy-pass>¶</a></h3><p>Once one has a <code>.mlir</code> file and a pass pipeline to run (such as that dumped in the crash reproducer file), then one should use <code>-print-ir-before-all</code> option to <code>mlir-opt</code> to print the IR before each pass. Additionally, <code>-print-ir-module-scope</code> and <code>-mlir-disable-threading</code> can be useful here.</p><p>If one is developing an MLIR-based compiler correctly (that is, with an attention to correct program translation, high quality verifiers, and clear diagnostics when correct translation isn&rsquo;t possible), then by far the most common class of bugs is that an error diagnostic is emitted. When this happens, the recommended course of action is to run all passes up to just before the pass that emitted the error diagnostic and save off a new <code>.mlir</code> file representing the IR just before the problematic pass was run.</p><p>If the problem is more complex than just a diagnostic / verifier error in a single pass, then more analysis of the <code>-print-ir-before-all</code> dumps will be needed, possibly by inserting extra debug printing into various passes to see where things went off the rails.</p><p>Either way, at the end of this process one should ideally have a <code>.mlir</code> file and a single pass (or manageable set of passes) to run in <code>mlir-opt</code> for further analysis.</p><p>TODO: testcase reduction, debugging miscompiles, bisection tools, general philosophical discussion of when and how to use bisection</p><div class=edit-meta><br></div><nav class=pagination><a class="nav nav-prev" href=/getting_started/ title="Getting Started"><i class="fas fa-arrow-left" aria-hidden=true></i>Prev - Getting Started</a>
<a class="nav nav-next" href=/getting_started/Faq/ title=FAQ>Next - FAQ <i class="fas fa-arrow-right" aria-hidden=true></i></a></nav><footer><p class=powered>Powered by <a href=https://gohugo.io>Hugo</a>. Theme by <a href=https://themes.gohugo.io/hugo-theme-techdoc/>TechDoc</a>. Designed by <a href=https://github.com/thingsym/hugo-theme-techdoc>Thingsym</a>.</p></footer></main><div class=sidebar><nav class=slide-menu><ul><li><a href>Home</a></li><li><a href=/talks/>Talks and Related Publications</a></li><li><a href=/users/>Users of MLIR</a></li><li class="parent has-sub-menu"><a href=/getting_started/>Getting Started<span class="mark opened">-</span></a><ul class=sub-menu><li class=active><a href=/getting_started/Debugging/>Debugging</a></li><li><a href=/getting_started/Faq/>FAQ</a></li><li><a href=/getting_started/Contributing/>How to Contribute</a></li><li><a href=/getting_started/DeveloperGuide/>Developer Guide</a></li><li><a href=/getting_started/openprojects/>Open Projects</a></li><li><a href=/getting_started/Glossary/>Glossary</a></li><li><a href=/getting_started/TestingGuide/>Testing Guide</a></li></ul></li></ul></nav><div class=sidebar-footer></div></div></div><a href=# id=backtothetop-fixed class=backtothetop data-backtothetop-duration=600 data-backtothetop-easing=easeOutQuart data-backtothetop-fixed-fadein=1000 data-backtothetop-fixed-fadeout=1000 data-backtothetop-fixed-bottom=10 data-backtothetop-fixed-right=20><span class="fa-layers fa-fw"><i class="fas fa-circle"></i><i class="fas fa-arrow-circle-up"></i></span></a></div></body></html>